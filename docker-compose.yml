version: '2'

volumes:
    pgdata:
    pgbackup:

services:
    postgres:
        container_name: living-archives-postgres
        build: ./compose/postgres
        volumes:
            - "pgdata:/var/lib/postgresql/data"
            - "pgbackup:/backups"
        env_file: .env-node

    node:
        container_name: living-archives-node
        build:
            context: .
            dockerfile: ./compose/node/Dockerfile
        env_file: .env-node
        depends_on:
            - postgres
        volumes:
            - ./node:/opt/node:rw

    nginx:
        container_name: living-archives-nginx
        build:
            context: .
            dockerfile: ./compose/nginx/Dockerfile
        depends_on:
            - node
        volumes_from:
            - node:rw
        ports:
            - "80:80"
            - "443:443"
            - "8001:8001" # skybox
            - "8002:8002" # root site
        volumes:
            - ./sites/skybox:/opt/sites/skybox:rw
            - ./sites/livingarchives:/opt/sites/livingarchives:rw
